<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Planilhas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .chart-container {
            transition: all 0.3s ease;
            min-height: 300px;
        }
        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .sidebar {
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: absolute;
                z-index: 10;
                height: 100vh;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .badge {
            display: inline-block;
            padding: 0.25em 0.4em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        .badge-primary {
            color: #fff;
            background-color: #4e73df;
        }
        .badge-success {
            color: #fff;
            background-color: #1cc88a;
        }
        .badge-info {
            color: #fff;
            background-color: #36b9cc;
        }
        .badge-warning {
            color: #1f2937;
            background-color: #f6c23e;
        }
        .badge-danger {
            color: #fff;
            background-color: #e74a3b;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .compact-table td, .compact-table th {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.875rem !important;
        }
        .search-result {
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.375rem;
        }
        .dropdown-content a {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            border-bottom: 1px solid #eee;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .chart-tooltip {
            background-color: rgba(0, 0, 0, 0.8) !important;
            border-radius: 4px !important;
            padding: 8px !important;
            color: white !important;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            animation: modalopen 0.4s;
        }
        @keyframes modalopen {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #888;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close-modal:hover {
            color: #555;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }
        .input-field {
            position: relative;
            margin-bottom: 20px;
        }
        .input-field input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .input-field input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }
        .input-field label {
            position: absolute;
            top: -10px;
            left: 10px;
            background: white;
            padding: 0 5px;
            font-size: 14px;
            color: #6366f1;
        }
        .modal-btn {
            width: 100%;
            padding: 12px;
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .modal-btn:hover {
            background-color: #4f46e5;
        }
        .modal-title {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }
        .modal-icon {
            text-align: center;
            margin-bottom: 20px;
            color: #6366f1;
            font-size: 40px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar bg-indigo-800 text-white w-64 flex-shrink-0 p-4 flex flex-col">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-2xl font-bold">Análise de Planilhas</h1>
                <button id="sidebarToggle" class="md:hidden text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Upload Section -->
            <div class="mb-4">
                <div class="file-upload bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow cursor-pointer transition duration-300 mb-2">
                    <span><i class="fas fa-file-excel mr-2"></i>Carregar Planilha</span>
                    <input type="file" id="fileInput" class="file-upload-input" accept=".xlsx, .xls, .csv">
                </div>
                <div class="bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow cursor-pointer transition duration-300">
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-link mr-2"></i>Google Sheets</span>
                        <i class="fas fa-info-circle" title="Cole a URL de uma planilha pública do Google Sheets"></i>
                    </div>
                    <input type="text" id="googleSheetsUrl" placeholder="Cole a URL do Google Sheets" class="w-full mt-2 px-2 py-1 text-sm text-gray-900 rounded">
                    <button id="loadGoogleSheetsBtn" class="w-full mt-2 bg-indigo-800 hover:bg-indigo-700 text-white font-medium py-1 px-2 rounded text-sm">
                        <span id="googleSheetsBtnText">Carregar</span>
                        <span id="googleSheetsSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
                <p class="text-sm text-indigo-200 mt-2">Suporta Excel, CSV e Google Sheets</p>
            </div>
            
            <!-- Sheet List -->
            <div id="sheetList" class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Planilhas</h3>
                <div id="sheetsContainer" class="space-y-1"></div>
            </div>
            
            <!-- Column Selector -->
            <div id="columnSelector" class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold">Colunas</h3>
                    <div class="flex space-x-1">
                        <button id="selectAllColumns" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-2 py-1 rounded">
                            Todos
                        </button>
                        <button id="deselectAllColumns" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-2 py-1 rounded">
                            Nenhum
                        </button>
                    </div>
                </div>
                <div id="columnsContainer" class="space-y-1 max-h-60 overflow-y-auto custom-scrollbar"></div>
            </div>
            
            <!-- Column Filter for Chart -->
            <div id="chartColumnFilter" class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Filtrar Gráfico</h3>
                <select id="chartColumnSelect" class="w-full p-2 rounded text-gray-800">
                    <option value="">Selecione uma coluna</option>
                    <!-- Options will be added dynamically -->
                </select>
            </div>
            
            <!-- Podio Button (hidden by default) -->
            <button id="podioBtn" class="hidden bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg shadow cursor-pointer transition duration-300 mb-4">
                <i class="fas fa-trophy mr-2"></i>Podio
            </button>
            
            <div class="mt-auto pt-4 border-t border-indigo-700">
                <p class="text-sm text-indigo-300">Dashboard v2.0</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Mobile Header -->
            <div class="md:hidden bg-indigo-800 text-white p-4 flex items-center justify-between">
                <h1 class="text-xl font-bold">Análise de Planilhas</h1>
                <button id="mobileSidebarToggle" class="text-white">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <!-- Dashboard Content -->
            <div class="p-6">
                <!-- Welcome Message -->
                <div id="welcomeMessage" class="bg-white rounded-xl shadow-md p-8 text-center">
                    <div class="text-indigo-500 mb-4">
                        <i class="fas fa-chart-pie text-5xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Bem-vindo ao Analisador de Planilhas</h2>
                    <p class="text-gray-600 mb-6">Carregue sua planilha para analisar os tipos de campos e visualizar os dados em gráficos.</p>
                    <div class="max-w-md mx-auto space-y-3">
                        <div class="file-upload bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow cursor-pointer inline-block transition duration-300 w-full">
                            <span><i class="fas fa-file-excel mr-2"></i>Selecionar Arquivo</span>
                            <input type="file" id="fileInputMobile" class="file-upload-input" accept=".xlsx, .xls, .csv">
                        </div>
                        <div class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow cursor-pointer transition duration-300">
                            <div class="flex items-center justify-center">
                                <span><i class="fas fa-link mr-2"></i>Google Sheets</span>
                                <i class="fas fa-info-circle ml-2" title="Cole a URL de uma planilha pública do Google Sheets"></i>
                            </div>
                            <input type="text" id="googleSheetsUrlMobile" placeholder="Cole a URL do Google Sheets" class="w-full mt-2 px-2 py-1 text-sm text-gray-900 rounded">
                            <button id="loadGoogleSheetsBtnMobile" class="w-full mt-2 bg-indigo-700 hover:bg-indigo-600 text-white font-medium py-1 px-2 rounded text-sm">
                                <span id="googleSheetsBtnTextMobile">Carregar</span>
                                <span id="googleSheetsSpinnerMobile" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Content (shown after file upload) -->
                <div id="dashboardContent" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Análise de Dados</h2>
                        <div class="flex items-center space-x-2">
                            <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-md flex items-center">
                                <i class="fas fa-sync-alt mr-2"></i> Atualizar
                            </button>
                            <button id="exportBtn" class="bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-md flex items-center">
                                <i class="fas fa-file-export mr-2"></i> Exportar
                            </button>
                        </div>
                    </div>

                    <!-- Search Section -->
                    <div class="bg-white rounded-lg shadow p-4 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div class="w-full md:w-auto">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar na Planilha</label>
                                <div class="flex">
                                    <input type="text" id="searchInput" placeholder="Digite o termo de busca..."
                                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-l-md">
                                    <button id="searchBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-r-md hover:bg-indigo-700">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="w-full md:w-auto">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Coluna</label>
                                <div class="dropdown">
                                    <button class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-md flex items-center justify-between w-full">
                                        <span id="selectedColumnText">Todas as colunas</span>
                                        <i class="fas fa-chevron-down ml-2"></i>
                                    </button>
                                    <div class="dropdown-content" id="columnDropdown">
                                        <a href="#" data-column="all" class="text-indigo-600 font-medium">Todas as colunas</a>
                                        <!-- Columns will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                            <div class="w-full md:w-auto flex items-end">
                                <button id="clearSearchBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md flex items-center">
                                    <i class="fas fa-times mr-2"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResultsContainer" class="hidden bg-white rounded-lg shadow mb-6">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">Resultados da Pesquisa</h3>
                            <div class="text-sm text-gray-500" id="searchResultsCount">0 resultados encontrados</div>
                        </div>
                        <div id="searchResults" class="overflow-y-auto custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr id="searchResultsHeader">
                                        <!-- Headers will be added here dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="searchResultsBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                            <div id="searchResultsFooter" class="p-4 border-t text-sm text-gray-500">
                                <!-- Footer content will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Total de Colunas</p>
                                    <h3 id="totalColumns" class="text-2xl font-bold text-gray-800">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                                    <i class="fas fa-columns text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Campos Booleanos</p>
                                    <h3 id="booleanFields" class="text-2xl font-bold text-gray-800">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-check-square text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Campos de Opções</p>
                                    <h3 id="optionFields" class="text-2xl font-bold text-gray-800">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-list-ul text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Outros Tipos</p>
                                    <h3 id="otherFields" class="text-2xl font-bold text-gray-800">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-question-circle text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div id="chartsContainer" class="space-y-6">
                        <!-- Field Types Pie Chart -->
                        <div class="chart-container bg-white rounded-xl shadow-md p-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Tipos de Campos na Planilha</h3>
                            <div class="relative h-64">
                                <canvas id="fieldTypesChart"></canvas>
                            </div>
                        </div>

                        <!-- Single Column Chart -->
                        <div id="singleColumnChartContainer" class="chart-container bg-white rounded-xl shadow-md p-4 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-800">Distribuição da Coluna Selecionada</h3>
                                <div class="relative w-64">
                                    <input type="text" id="chartSearchInput" placeholder="Pesquisar no gráfico..." 
                                        class="w-full pl-3 pr-10 py-2 text-sm border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-4">
                                <div class="relative h-64 flex-1 min-w-[300px]">
                                    <canvas id="singleColumnChart"></canvas>
                                </div>
                                <div id="chartLegend" class="flex-1 min-w-[200px] max-h-64 overflow-y-auto custom-scrollbar p-2 border rounded-lg">
                                    <!-- Legend will be added here -->
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                <p><strong>Dica:</strong> Valores "Sim" são exibidos em verde e "Não" em vermelho.</p>
                            </div>
                        </div>

                        <!-- Bar Chart Container (added) -->
                        <div id="barChartContainer" class="chart-container bg-white rounded-xl shadow-md p-4 hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Distribuição em Barras</h3>
                            <div class="relative h-64">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h2 class="modal-title">Acesso ao Podio</h2>
            <form id="loginForm">
                <div class="input-field">
                    <input type="text" id="username" required>
                    <label for="username">Usuário</label>
                </div>
                <div class="input-field">
                    <input type="password" id="password" required>
                    <label for="password">Senha</label>
                </div>
                <button type="submit" class="modal-btn">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <script>
        // Main Application
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const elements = {
                fileInput: document.getElementById('fileInput'),
                fileInputMobile: document.getElementById('fileInputMobile'),
                welcomeMessage: document.getElementById('welcomeMessage'),
                dashboardContent: document.getElementById('dashboardContent'),
                sheetsContainer: document.getElementById('sheetsContainer'),
                columnsContainer: document.getElementById('columnsContainer'),
                exportBtn: document.getElementById('exportBtn'),
                refreshBtn: document.getElementById('refreshBtn'),
                clearSearchBtn: document.getElementById('clearSearchBtn'),
                sidebarToggle: document.getElementById('sidebarToggle'),
                mobileSidebarToggle: document.getElementById('mobileSidebarToggle'),
                sidebar: document.querySelector('.sidebar'),
                selectAllColumns: document.getElementById('selectAllColumns'),
                deselectAllColumns: document.getElementById('deselectAllColumns'),
                chartsContainer: document.getElementById('chartsContainer'),
                searchInput: document.getElementById('searchInput'),
                searchBtn: document.getElementById('searchBtn'),
                searchResultsContainer: document.getElementById('searchResultsContainer'),
                searchResults: document.getElementById('searchResults'),
                searchResultsBody: document.getElementById('searchResultsBody'),
                searchResultsHeader: document.getElementById('searchResultsHeader'),
                searchResultsCount: document.getElementById('searchResultsCount'),
                searchResultsFooter: document.getElementById('searchResultsFooter'),
                columnDropdown: document.getElementById('columnDropdown'),
                selectedColumnText: document.getElementById('selectedColumnText'),
                googleSheetsUrl: document.getElementById('googleSheetsUrl'),
                loadGoogleSheetsBtn: document.getElementById('loadGoogleSheetsBtn'),
                googleSheetsBtnText: document.getElementById('googleSheetsBtnText'),
                googleSheetsSpinner: document.getElementById('googleSheetsSpinner'),
                googleSheetsUrlMobile: document.getElementById('googleSheetsUrlMobile'),
                loadGoogleSheetsBtnMobile: document.getElementById('loadGoogleSheetsBtnMobile'),
                googleSheetsBtnTextMobile: document.getElementById('googleSheetsBtnTextMobile'),
                googleSheetsSpinnerMobile: document.getElementById('googleSheetsSpinnerMobile'),
                totalColumnsEl: document.getElementById('totalColumns'),
                booleanFieldsEl: document.getElementById('booleanFields'),
                optionFieldsEl: document.getElementById('optionFields'),
                otherFieldsEl: document.getElementById('otherFields'),
                fieldTypesChartCtx: document.getElementById('fieldTypesChart').getContext('2d'),
                singleColumnChartCtx: document.getElementById('singleColumnChart').getContext('2d'),
                barChartCtx: document.getElementById('barChart').getContext('2d'),
                chartColumnSelect: document.getElementById('chartColumnSelect'),
                singleColumnChartContainer: document.getElementById('singleColumnChartContainer'),
                barChartContainer: document.getElementById('barChartContainer'),
                chartSearchInput: document.getElementById('chartSearchInput'),
                chartLegend: document.getElementById('chartLegend'),
                podioBtn: document.getElementById('podioBtn'),
                loginModal: document.getElementById('loginModal'),
                closeModal: document.querySelector('.close-modal'),
                loginForm: document.getElementById('loginForm'),
                username: document.getElementById('username'),
                password: document.getElementById('password')
            };

            // Application State
            const state = {
                workbook: null,
                currentSheetName: '',
                currentSheetData: [],
                fieldTypesChart: null,
                singleColumnChart: null,
                barChart: null,
                fieldAnalysis: {
                    booleanFields: [],
                    optionFields: [],
                    otherFields: []
                },
                selectedColumns: [],
                selectedSearchColumn: 'all',
                allColumnsAnalysis: [],
                chartColors: {},
                googleSheetsUrl: '',
                // Colunas que não devem aparecer nos gráficos
                excludedColumnsFromCharts: [
                    'LOGIN PPPOE', 'IPV4', 'POTENCIA SINAL ONU', 'OBSERVAÇÕES',
                    'LOGIN PPPOE', 'IPV4', 'POTÊNCIA SINAL ONU', 'OBSERVAÇÕES' // Versões com acentos
                ]
            };

            // Initialize Event Listeners
            function initEventListeners() {
                // File Upload
                elements.fileInput.addEventListener('change', handleFileUpload);
                elements.fileInputMobile.addEventListener('change', handleFileUpload);
                
                // UI Interactions
                elements.exportBtn.addEventListener('click', exportDashboard);
                elements.refreshBtn.addEventListener('click', refreshData);
                elements.clearSearchBtn.addEventListener('click', clearSearchResults);
                elements.sidebarToggle.addEventListener('click', toggleSidebar);
                elements.mobileSidebarToggle.addEventListener('click', toggleSidebar);
                elements.selectAllColumns.addEventListener('click', () => toggleAllColumns(true));
                elements.deselectAllColumns.addEventListener('click', () => toggleAllColumns(false));
                
                // Search Functionality
                elements.searchBtn.addEventListener('click', performSearch);
                elements.searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') performSearch();
                });
                
                // Chart Search
                elements.chartSearchInput.addEventListener('input', filterChartLegend);
                
                // Google Sheets Integration
                elements.loadGoogleSheetsBtn.addEventListener('click', loadGoogleSheets);
                elements.loadGoogleSheetsBtnMobile.addEventListener('click', loadGoogleSheets);
                elements.googleSheetsUrl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') loadGoogleSheets();
                });
                elements.googleSheetsUrl.addEventListener('input', function(e) {
                    state.googleSheetsUrl = e.target.value;
                });
                elements.googleSheetsUrlMobile.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') loadGoogleSheets();
                });
                
                // Column Dropdown
                elements.columnDropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (e.target.tagName === 'A') {
                        const column = e.target.dataset.column;
                        state.selectedSearchColumn = column;
                        elements.selectedColumnText.textContent = column === 'all' ? 'Todas as colunas' : column;
                        performSearch();
                    }
                });
                
                // Chart Column Selector
                elements.chartColumnSelect.addEventListener('change', function() {
                    updateSingleColumnChart();
                    updateBarChart();
                });
                
                // Podio Button
                elements.podioBtn.addEventListener('click', showLoginModal);
                
                // Modal Interactions
                elements.closeModal.addEventListener('click', hideLoginModal);
                elements.loginForm.addEventListener('submit', handleLogin);
                
                // Close modal when clicking outside
                window.addEventListener('click', function(event) {
                    if (event.target === elements.loginModal) {
                        hideLoginModal();
                    }
                });
            }

            // UI Functions
            function toggleSidebar() {
                elements.sidebar.classList.toggle('open');
            }

            function toggleAllColumns(select) {
                const checkboxes = document.querySelectorAll('.column-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = select;
                    const columnName = checkbox.dataset.column;
                    if (select && !state.selectedColumns.includes(columnName)) {
                        state.selectedColumns.push(columnName);
                    } else if (!select) {
                        state.selectedColumns = [];
                    }
                });
                updateFieldDetailsTable();
            }

            function refreshData() {
                if (state.googleSheetsUrl) {
                    // If we have a Google Sheets URL, reload it
                    elements.googleSheetsUrl.value = state.googleSheetsUrl;
                    loadGoogleSheets();
                } else if (state.workbook) {
                    // If we have a workbook, reload the current sheet
                    loadSheet(state.currentSheetName);
                } else {
                    // Otherwise just refresh the page
                    location.reload();
                }
            }

            function clearSearchResults() {
                elements.searchInput.value = '';
                elements.searchResultsContainer.classList.add('hidden');
                elements.selectedColumnText.textContent = 'Todas as colunas';
                state.selectedSearchColumn = 'all';
            }

            function showLoginModal() {
                elements.loginModal.style.display = 'block';
            }

            function hideLoginModal() {
                elements.loginModal.style.display = 'none';
                elements.loginForm.reset();
            }

            function handleLogin(e) {
                e.preventDefault();
                const username = elements.username.value.trim();
                const password = elements.password.value.trim();
                
                if (username === 'Natanael' && password === 'toledo2025') {
                    hideLoginModal();
                    // Redirect to podio.html
                    window.location.href = 'podio.html';
                } else {
                    alert('Usuário ou senha incorretos!');
                }
            }

            // Data Processing Functions
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    state.workbook = XLSX.read(data, { type: 'array' });

                    // Update UI
                    updateSheetList();
                    elements.welcomeMessage.classList.add('hidden');
                    elements.dashboardContent.classList.remove('hidden');
                    elements.podioBtn.classList.remove('hidden');

                    // Load first sheet by default
                    if (state.workbook.SheetNames.length > 0) {
                        loadSheet(state.workbook.SheetNames[0]);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function loadGoogleSheets() {
                const url = elements.googleSheetsUrl.value || elements.googleSheetsUrlMobile.value;
                if (!url) {
                    alert('Por favor, cole a URL do Google Sheets');
                    return;
                }

                // Store the URL for refresh functionality
                state.googleSheetsUrl = url;

                // Show loading state
                elements.googleSheetsBtnText.textContent = 'Carregando...';
                elements.googleSheetsSpinner.classList.remove('hidden');
                elements.googleSheetsBtnTextMobile.textContent = 'Carregando...';
                elements.googleSheetsSpinnerMobile.classList.remove('hidden');

                try {
                    // Extract spreadsheet ID
                    let spreadsheetId = '';
                    const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    spreadsheetId = match && match[1] ? match[1] : url;

                    // Construct export URL
                    const exportUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx`;

                    // Fetch and process the file
                    fetch(exportUrl)
                        .then(response => {
                            if (!response.ok) throw new Error('Erro ao carregar a planilha. Verifique a URL e se a planilha é pública.');
                            return response.arrayBuffer();
                        })
                        .then(data => {
                            state.workbook = XLSX.read(new Uint8Array(data), { type: 'array' });

                            // Update UI
                            updateSheetList();
                            elements.welcomeMessage.classList.add('hidden');
                    elements.dashboardContent.classList.remove('hidden');
                    elements.podioBtn.classList.remove('hidden');

                    // Load first sheet by default
                    if (state.workbook.SheetNames.length > 0) {
                        loadSheet(state.workbook.SheetNames[0]);
                    }

                    // Reset loading state
                    resetGoogleSheetsLoadingState();
                })
                .catch(error => {
                    alert(error.message);
                    console.error('Error loading Google Sheets:', error);
                    resetGoogleSheetsLoadingState();
                });
            } catch (error) {
                alert('Erro ao processar a URL. Verifique se é uma URL válida do Google Sheets.');
                console.error('Error processing Google Sheets URL:', error);
                resetGoogleSheetsLoadingState();
            }
        }

        function resetGoogleSheetsLoadingState() {
            elements.googleSheetsBtnText.textContent = 'Carregar';
            elements.googleSheetsSpinner.classList.add('hidden');
            elements.googleSheetsBtnTextMobile.textContent = 'Carregar';
            elements.googleSheetsSpinnerMobile.classList.add('hidden');
        }

        function updateSheetList() {
            elements.sheetsContainer.innerHTML = '';
            state.workbook.SheetNames.forEach(sheetName => {
                const sheetBtn = document.createElement('button');
                sheetBtn.className = `w-full text-left py-2 px-3 rounded ${sheetName === state.currentSheetName ? 'bg-indigo-600 text-white' : 'text-indigo-200 hover:bg-indigo-700'}`;
                sheetBtn.textContent = sheetName;
                sheetBtn.addEventListener('click', () => loadSheet(sheetName));
                elements.sheetsContainer.appendChild(sheetBtn);
            });
        }

        function updateColumnsList() {
            elements.columnsContainer.innerHTML = '';
            elements.columnDropdown.innerHTML = '<a href="#" data-column="all" class="text-indigo-600 font-medium">Todas as colunas</a>';
            elements.chartColumnSelect.innerHTML = '<option value="">Selecione uma coluna</option>';
            state.selectedColumns = [];

            if (!state.currentSheetData.length) return;

            const headers = state.currentSheetData[0];
            headers.forEach((header, index) => {
                if (!header) return;

                // Add to column selector in sidebar
                const columnItem = document.createElement('div');
                columnItem.className = 'flex items-center py-1 px-2 rounded hover:bg-indigo-700';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'column-checkbox mr-2';
                checkbox.dataset.column = header;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        if (!state.selectedColumns.includes(header)) {
                            state.selectedColumns.push(header);
                        }
                    } else {
                        state.selectedColumns = state.selectedColumns.filter(col => col !== header);
                    }
                    updateFieldDetailsTable();
                });

                const columnName = document.createElement('span');
                columnName.className = 'text-sm text-indigo-200 truncate';
                columnName.textContent = header;

                columnItem.appendChild(checkbox);
                columnItem.appendChild(columnName);
                elements.columnsContainer.appendChild(columnItem);

                // Add to search column dropdown
                const dropdownItem = document.createElement('a');
                dropdownItem.href = '#';
                dropdownItem.dataset.column = header;
                dropdownItem.textContent = header;
                elements.columnDropdown.appendChild(dropdownItem);

                // Add to chart column selector (excluindo as colunas especificadas)
                if (!state.excludedColumnsFromCharts.some(excluded => 
                    header.toLowerCase().includes(excluded.toLowerCase())
                )) {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    elements.chartColumnSelect.appendChild(option);
                }

                state.selectedColumns.push(header);
            });
        }

        function loadSheet(sheetName) {
            state.currentSheetName = sheetName;
            const worksheet = state.workbook.Sheets[sheetName];
            state.currentSheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });

            // Update UI
            updateSheetList();
            updateColumnsList();

            // Analyze data
            analyzeFields();

            // Update visualizations
            updateSummaryCards();
            updateCharts();
            updateFieldDetailsTable();
        }

        function analyzeFields() {
            if (state.currentSheetData.length < 2) return;

            const headers = state.currentSheetData[0];
            const dataRows = state.currentSheetData.slice(1);
            state.allColumnsAnalysis = [];

            // Reset field analysis
            state.fieldAnalysis = {
                booleanFields: [],
                optionFields: [],
                otherFields: []
            };

            // Analyze each column
            for (let col = 0; col < headers.length; col++) {
                const columnName = headers[col];
                let values = dataRows.map(row => row[col]).filter(val => val !== undefined && val !== null && val !== '');

                if (values.length === 0) {
                    values = ['Vazio'];
                }

                const uniqueValues = [...new Set(values.map(v => String(v)))];
                const valueCounts = {};

                uniqueValues.forEach(val => {
                    valueCounts[val] = values.filter(v => String(v) === val).length;
                });

                // Classify field type
                const total = values.length;
                const isBoolean = uniqueValues.every(val => 
                    ['true', 'false', 'verdadeiro', 'falso', 'sim', 'não', 'yes', 'no', '1', '0'].includes(val.toLowerCase())
                );

                const isOption = uniqueValues.length <= 10 && uniqueValues.length > 1;

                // Store analysis for this column
                const columnAnalysis = {
                    name: columnName,
                    uniqueValues: uniqueValues,
                    valueCounts: valueCounts,
                    total: total,
                    isBoolean: isBoolean,
                    isOption: isOption,
                    // Verifica se a coluna deve ser excluída dos gráficos
                    excludeFromChart: state.excludedColumnsFromCharts.some(excluded => 
                        columnName.toLowerCase().includes(excluded.toLowerCase())
                    )
                };

                state.allColumnsAnalysis.push(columnAnalysis);

                // Categorize the field
                if (isBoolean) {
                    const trueCount = values.filter(v => 
                        ['true', 'verdadeiro', 'sim', 'yes', '1'].includes(String(v).toLowerCase())
                    ).length;
                    
                    state.fieldAnalysis.booleanFields.push({
                        name: columnName,
                        trueCount: trueCount,
                        falseCount: total - trueCount,
                        total: total,
                        excludeFromChart: columnAnalysis.excludeFromChart
                    });
                } else if (isOption) {
                    state.fieldAnalysis.optionFields.push({
                        name: columnName,
                        valueCounts: valueCounts,
                        total: total,
                        excludeFromChart: columnAnalysis.excludeFromChart
                    });
                } else {
                    state.fieldAnalysis.otherFields.push({
                        name: columnName,
                        uniqueValues: uniqueValues,
                        total: total,
                        excludeFromChart: columnAnalysis.excludeFromChart
                    });
                }
            }
        }

        function updateSummaryCards() {
            // Conta todas as colunas, incluindo as excluídas
            elements.totalColumnsEl.textContent = state.currentSheetData[0] ? state.currentSheetData[0].length : 0;
            
            // Conta apenas os campos booleanos que não estão excluídos
            elements.booleanFieldsEl.textContent = state.fieldAnalysis.booleanFields.filter(f => !f.excludeFromChart).length;
            
            // Conta apenas os campos de opções que não estão excluídos
            elements.optionFieldsEl.textContent = state.fieldAnalysis.optionFields.filter(f => !f.excludeFromChart).length;
            
            // Conta apenas os outros campos que não estão excluídos
            elements.otherFieldsEl.textContent = state.fieldAnalysis.otherFields.filter(f => !f.excludeFromChart).length;
        }

        function updateCharts() {
            // Clear existing charts
            if (state.fieldTypesChart) state.fieldTypesChart.destroy();
            if (state.singleColumnChart) state.singleColumnChart.destroy();
            if (state.barChart) state.barChart.destroy();
            
            // Create field types pie chart (excluindo as colunas especificadas)
            createFieldTypesChart();
            
            // Hide single column chart initially
            elements.singleColumnChartContainer.classList.add('hidden');
            elements.barChartContainer.classList.add('hidden');
        }

        function createFieldTypesChart() {
            // Filtra as colunas excluídas
            const booleanFields = state.fieldAnalysis.booleanFields.filter(f => !f.excludeFromChart);
            const optionFields = state.fieldAnalysis.optionFields.filter(f => !f.excludeFromChart);
            const otherFields = state.fieldAnalysis.otherFields.filter(f => !f.excludeFromChart);

            const fieldTypeData = [
                booleanFields.length,
                optionFields.length,
                otherFields.length
            ];
            const fieldTypeLabels = ['Booleanos', 'Opções', 'Outros'];

            state.fieldTypesChart = new Chart(elements.fieldTypesChartCtx, {
                type: 'pie',
                data: {
                    labels: fieldTypeLabels,
                    datasets: [{
                        data: fieldTypeData,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = fieldTypeData.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSingleColumnChart() {
            const selectedColumn = elements.chartColumnSelect.value;
            if (!selectedColumn) {
                elements.singleColumnChartContainer.classList.add('hidden');
                return;
            }

            // Find the column analysis
            const columnAnalysis = state.allColumnsAnalysis.find(col => col.name === selectedColumn);
            if (!columnAnalysis) return;

            // Show the container
            elements.singleColumnChartContainer.classList.remove('hidden');

            // Update the title
            elements.singleColumnChartContainer.querySelector('h3').textContent = `Distribuição: ${selectedColumn}`;

            // Destroy previous chart if exists
            if (state.singleColumnChart) {
                state.singleColumnChart.destroy();
            }

            // Prepare data for the chart
            const labels = Object.keys(columnAnalysis.valueCounts);
            const data = Object.values(columnAnalysis.valueCounts);
            
            // Generate distinct colors for each segment and store them
            state.chartColors = {};
            const backgroundColors = labels.map((label, i) => {
                // Special colors for "Sim" and "Não"
                const lowerLabel = label.toLowerCase();
                if (lowerLabel === 'sim' || lowerLabel === 'yes' || lowerLabel === 'true' || lowerLabel === 'verdadeiro' || lowerLabel === '1') {
                    state.chartColors[label] = '#4CAF50'; // Green
                    return '#4CAF50';
                } else if (lowerLabel === 'não' || lowerLabel === 'no' || lowerLabel === 'false' || lowerLabel === 'falso' || lowerLabel === '0') {
                    state.chartColors[label] = '#F44336'; // Red
                    return '#F44336';
                } else {
                    const color = `hsl(${i * 360 / labels.length}, 70%, 60%)`;
                    state.chartColors[label] = color;
                    return color;
                }
            });

            // Create the pie chart
            state.singleColumnChart = new Chart(elements.singleColumnChartCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            display: labels.length <= 10 // Only show legend if not too many items
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a,b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Update the legend with search functionality
            updateChartLegend(labels, data, columnAnalysis.total);
        }

        function updateBarChart() {
            const selectedColumn = elements.chartColumnSelect.value;
            if (!selectedColumn) {
                elements.barChartContainer.classList.add('hidden');
                return;
            }

            // Find the column analysis
            const columnAnalysis = state.allColumnsAnalysis.find(col => col.name === selectedColumn);
            if (!columnAnalysis) return;

            // Show the container
            elements.barChartContainer.classList.remove('hidden');

            // Destroy previous chart if exists
            if (state.barChart) {
                state.barChart.destroy();
            }

            // Prepare data for the chart
            const labels = Object.keys(columnAnalysis.valueCounts);
            const data = Object.values(columnAnalysis.valueCounts);
            
            // Generate colors for bars
            const backgroundColors = labels.map(label => {
                // Special colors for "Sim" and "Não"
                const lowerLabel = label.toLowerCase();
                if (lowerLabel === 'sim' || lowerLabel === 'yes' || lowerLabel === 'true' || lowerLabel === 'verdadeiro' || lowerLabel === '1') {
                    return '#4CAF50'; // Green
                } else if (lowerLabel === 'não' || lowerLabel === 'no' || lowerLabel === 'false' || lowerLabel === 'falso' || lowerLabel === '0') {
                    return '#F44336'; // Red
                } else {
                    return state.chartColors[label] || '#3B82F6'; // Default blue
                }
            });

            // Create the bar chart
            state.barChart = new Chart(elements.barChartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Contagem',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: selectedColumn
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = columnAnalysis.total;
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartLegend(labels, data, total) {
            elements.chartLegend.innerHTML = '';
            
            labels.forEach((label, index) => {
                const percentage = ((data[index] / total) * 100).toFixed(1);
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item p-2 hover:bg-gray-100 rounded';
                legendItem.dataset.label = label.toLowerCase();
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = state.chartColors[label];
                
                const textSpan = document.createElement('span');
                textSpan.className = 'text-sm text-gray-700';
                textSpan.innerHTML = `<strong>${label}</strong>: ${data[index]} (${percentage}%)`;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(textSpan);
                elements.chartLegend.appendChild(legendItem);
            });
        }

        function filterChartLegend() {
            const searchTerm = elements.chartSearchInput.value.trim().toLowerCase();
            const legendItems = elements.chartLegend.querySelectorAll('.legend-item');
            
            legendItems.forEach(item => {
                const label = item.dataset.label;
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateFieldDetailsTable() {
            // This function would update a table showing field details
            // Implementation depends on your specific requirements
        }

        function performSearch() {
            const searchTerm = elements.searchInput.value.trim().toLowerCase();
            if (!searchTerm || !state.currentSheetData.length) return;

            elements.searchResultsBody.innerHTML = '';
            elements.searchResultsHeader.innerHTML = '';
            elements.searchResultsContainer.classList.remove('hidden');

            const headers = state.currentSheetData[0];
            const dataRows = state.currentSheetData.slice(1);

            // Create table headers
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header || 'Coluna';
                elements.searchResultsHeader.appendChild(th);
            });

            let resultCount = 0;

            // Search through data
            dataRows.forEach((row, rowIndex) => {
                let matchFound = false;
                
                if (state.selectedSearchColumn === 'all') {
                    // Search in all columns (incluindo as colunas excluídas dos gráficos)
                    for (let col = 0; col < row.length; col++) {
                        const cellValue = row[col];
                        if (cellValue !== undefined && cellValue !== null && 
                            String(cellValue).toLowerCase().includes(searchTerm)) {
                            matchFound = true;
                            break;
                        }
                    }
                } else {
                    // Search in specific column (incluindo as colunas excluídas dos gráficos)
                    const colIndex = headers.indexOf(state.selectedSearchColumn);
                    if (colIndex !== -1) {
                        const cellValue = row[colIndex];
                        if (cellValue !== undefined && cellValue !== null && 
                            String(cellValue).toLowerCase().includes(searchTerm)) {
                            matchFound = true;
                        }
                    }
                }

                if (matchFound) {
                    resultCount++;
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';

                    // Add all cells from the row (incluindo as colunas excluídas dos gráficos)
                    row.forEach((cell, colIndex) => {
                        const td = document.createElement('td');
                        td.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-500';
                        
                        // Handle null/undefined values
                        const cellValue = cell === undefined || cell === null ? 'null' : String(cell);
                        
                        // Highlight matching cells
                        if (cellValue.toLowerCase().includes(searchTerm) && 
                            (state.selectedSearchColumn === 'all' || headers[colIndex] === state.selectedSearchColumn)) {
                            td.innerHTML = `<span class="bg-yellow-100 px-1 rounded">${cellValue}</span>`;
                        } else {
                            td.textContent = cellValue;
                        }
                        
                        tr.appendChild(td);
                    });

                    // Fill empty cells if row has fewer columns than headers
                    for (let i = row.length; i < headers.length; i++) {
                        const td = document.createElement('td');
                        td.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-500';
                        td.textContent = 'null';
                        tr.appendChild(td);
                    }

                    elements.searchResultsBody.appendChild(tr);
                }
            });

            // Update results count
            elements.searchResultsCount.textContent = `${resultCount} resultado${resultCount !== 1 ? 's' : ''} encontrado${resultCount !== 1 ? 's' : ''}`;

            // Show no results message if needed
            if (resultCount === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = headers.length;
                td.className = 'text-center py-4 text-gray-500';
                td.textContent = 'Nenhum resultado encontrado';
                tr.appendChild(td);
                elements.searchResultsBody.appendChild(tr);
            }

            // Adiciona informações sobre colunas excluídas no rodapé
            const excludedColumns = state.currentSheetData[0]?.filter(header => 
                state.excludedColumnsFromCharts.some(excluded => 
                    header && header.toLowerCase().includes(excluded.toLowerCase())
                )
            ) || [];

            if (excludedColumns.length > 0) {
                elements.searchResultsFooter.innerHTML = `
                    <div class="text-sm text-gray-600">
                        <p><strong>Observação:</strong> As seguintes colunas estão disponíveis para filtro mas não são exibidas nos gráficos:</p>
                        <p class="mt-1">${excludedColumns.join(', ')}</p>
                    </div>
                `;
            }
        }

        function exportDashboard() {
            if (!state.workbook) return;

            // Create a new workbook with the analysis
            const wb = XLSX.utils.book_new();

            // Add the original data sheet
            const ws = XLSX.utils.aoa_to_sheet(state.currentSheetData);
            XLSX.utils.book_append_sheet(wb, ws, 'Dados Originais');

            // Prepare analysis data
            const analysisData = [
                ['Análise de Dados'],
                [''],
                ['Total de Colunas', state.currentSheetData[0] ? state.currentSheetData[0].length : 0],
                ['Campos Booleanos', state.fieldAnalysis.booleanFields.length],
                ['Campos de Opções', state.fieldAnalysis.optionFields.length],
                ['Outros Campos', state.fieldAnalysis.otherFields.length],
                [''],
                ['Colunas excluídas dos gráficos', state.excludedColumnsFromCharts.join(', ')],
                [''],
                ['Detalhes dos Campos']
            ];

            // Add boolean fields
            state.fieldAnalysis.booleanFields.forEach(field => {
                analysisData.push([field.name, 'Booleano', `Verdadeiro: ${field.trueCount}, Falso: ${field.falseCount}`]);
            });

            // Add option fields
            state.fieldAnalysis.optionFields.forEach(field => {
                const optionsText = Object.entries(field.valueCounts)
                    .map(([value, count]) => `${value}: ${count}`)
                    .join('; ');
                analysisData.push([field.name, 'Opções', optionsText]);
            });

            // Add other fields
            state.fieldAnalysis.otherFields.forEach(field => {
                analysisData.push([field.name, 'Outro', `${field.uniqueValues.length} valores únicos`]);
            });

            // Add analysis sheet
            const analysisWs = XLSX.utils.aoa_to_sheet(analysisData);
            XLSX.utils.book_append_sheet(wb, analysisWs, 'Análise');

            // Export the file
            XLSX.writeFile(wb, `Planilha_Analisada_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Initialize the application
        initEventListeners();
    });
</script>
</body>
</html>